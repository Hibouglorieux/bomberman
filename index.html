<!DOCTYPE html>
<html>
<head>
    <script src="phaser/dist/phaser.js"></script>
</head>
<body>
    <script>
		const GET_MY_ID = 'I'
		const ADD_PLAYER = 'A'
		const MOVE = 'M'
	let id = -1;
	let Players = {};
	let must_add = [];
        let socket = new WebSocket("ws://10.1.4.4:43681/ws"); // you might want to change that to your local address, and add another redirection to 11337 port in VM dear Hubert
        console.log("Attempting Connection...");
        socket.onopen = () => {
            console.log("Successfully Connected");
            socket.send("iHi From the Client!")
        };
        
        socket.onclose = event => {
            console.log("Socket Closed Connection: ", event);
            socket.send("Client Closed!")
        };

        socket.onerror = error => {
            console.log("Socket Error: ", error);
        };

        socket.onmessage = function(event) {// this is the function used to tread message received throught event.data which is the string received from server
            console.log("received a message: ", event.data);
			if (event.data[0] == GET_MY_ID) // tells you which player you are
			{
				id = parseInt(event.data[2]);
				socket.send("new".concat(id.toString()));
				if (id >= 2)
					must_add.push(1);
				if (id == 3)
					must_add.push(2);
			}
			if (event.data[0] == ADD_PLAYER) // makes it pop on screen
				must_add.push(parseInt(event.data[3]));
			if (event.data[0] == MOVE)// makes other player move in real time
			{
				let nb = event.data[2].charCodeAt() - 48;
				console.log(typeof nb, nb);
				console.log(Players);
				if (typeof Players.player[nb] == 'undefined' || typeof Players.player[nb] == 'undefined')
					return ;
				let nb2 = parseInt(event.data.slice(3));
				if (event.data[1] == 'x')
					Players.player[nb].anim.x = nb2;
				if (event.data[1] == 'y')
					Players.player[nb].anim.y = nb2;
			}
        };

    const level = [
        [   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1],
        [   1,   0,   0,   2,   2,   2,   2,   2,   2,   2,   2,   2,   0,   0,   1],
        [   1,   0,   1,   2,   1,   2,   1,   2,   1,   2,   1,   2,   1,   0,   1],
        [   1,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   1],
        [   1,   2,   1,   2,   1,   2,   1,   2,   1,   2,   1,   2,   1,   2,   1],
        [   1,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   1],
        [   1,   2,   1,   2,   1,   2,   1,   2,   1,   2,   1,   2,   1,   2,   1],
        [   1,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   1],
        [   1,   2,   1,   2,   1,   2,   1,   2,   1,   2,   1,   2,   1,   2,   1],
        [   1,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   1],
        [   1,   0,   1,   2,   1,   2,   1,   2,   1,   2,   1,   2,   1,   0,   1],
        [   1,   0,   0,   2,   2,   2,   2,   2,   2,   2,   2,   2,   0,   0,   1],
        [   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1]
    ];
    let mur = new Array(13);
    for (let i = 0; i < mur.length; i++)
    {
        mur[i] = new Array(15);
    }
	const WHITE = 0;
	const BLACK = 1;
	const BLUE = 2;
	const RED = 3;
	const UP = 0;
	const RIGHT = 1;
	const DOWN = 2;
	const LEFT = 3;
    const scale = 1;
    const mvnt_liberty = 6;
    const speed = 7;
    const start_x = 1;
    const start_y = 1;
    const tile_size = 64;
    const width = 960;
    const height = 832;
       let config = {
    type: Phaser.AUTO,
    width: width,
    height: height,
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};

var game = new Phaser.Game(config);

function preload ()
{
	console.log('preloading');
	load_images(this);
}

function create ()
{
	console.log('creating');
     key_up = this.input.keyboard.addKey('W');
     key_up2 = this.input.keyboard.addKey(38); // UP arrow
     key_right = this.input.keyboard.addKey('D');
     key_right2 = this.input.keyboard.addKey(39); // RIGHT arrow
     key_bottom = this.input.keyboard.addKey('S');
     key_bottom2 = this.input.keyboard.addKey(40); // DOWN arrow
     key_left = this.input.keyboard.addKey('A');
     key_left2 = this.input.keyboard.addKey(37); // LEFT arrow
	key_space = this.input.keyboard.addKey('SPACE');
	key_p = this.input.keyboard.addKey('P');

    const map = this.add.image(width / 2, height / 2, 'map');
	Players.player = [];
	Players.player[0] = {
		anim: this.add.sprite(get_coord_x(start_x), get_coord_y_player(start_y), 'w_down_0'),
		face : DOWN};
	Players.player[0].anim.setDepth(1); // must set to all (or not ? to discuss)
	create_anim();
	for (var i = 0; i < level.length; i++) {
		for (var j = 0; j < level[i].length; j++) {
			if (level[i][j] == 2)
			{
				mur[i][j] = this.add.sprite(get_coord_x(j), get_coord_y(i), 'bomb-0');
			}
		} 
	}
	create_anim();
}

let global = {bombs:[], explo:[]};

function update ()
{
	if (must_add.length != 0)
		init_id(this);
	if (id == -1)
		return ;
	if (typeof Players.player[id] == 'undefined')
		return ;
	if (typeof update.key == 'undefined')
		update.key = -1;
	if (Phaser.Input.Keyboard.JustDown(key_up) || Phaser.Input.Keyboard.JustDown(key_up2))
		update.key = UP;
	else if (Phaser.Input.Keyboard.JustDown(key_right) || Phaser.Input.Keyboard.JustDown(key_right2))
		update.key = RIGHT;
	else if (Phaser.Input.Keyboard.JustDown(key_bottom) || Phaser.Input.Keyboard.JustDown(key_bottom2))
		update.key = DOWN;
	else if (Phaser.Input.Keyboard.JustDown(key_left) || Phaser.Input.Keyboard.JustDown(key_left2))
		update.key = LEFT;
	if (update.key == UP && key_up.isUp && key_up2.isUp)
		update.key = -1;
	if (update.key == RIGHT && key_right.isUp && key_right2.isUp)
		update.key = -1;
	if (update.key == DOWN && key_bottom.isUp && key_bottom2.isUp)
		update.key = -1;
	if (update.key == LEFT && key_left.isUp && key_left2.isUp)
		update.key = -1;
	movement(update.key, Players.player[id]);
	if (key_space.isDown)
	{
		let pos = player_pixel_2_map(Players.player[id].anim);
		global.bombs.push(bomb_anim(this, pos, 3));
	}

}
	</script>

	<script src="create_anim.js"></script>
	<script src="manage_mvt.js"></script>
	<script src="create_bomb_anim.js"></script>
	<script src="load_images.js"></script>
	<script src="utils.js"></script>
	<script src="manage_explosion.js"></script>
	<script src="init.js"></script>
</body>
</html>
