<!DOCTYPE html>
<html>
<head>
    <script src="./phaser/dist/phaser.js"></script>
</head>
<body>

    <script>
    const level = [
        [   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1],
        [   1,   0,   0,   2,   2,   2,   2,   2,   2,   2,   2,   2,   0,   0,   1],
        [   1,   0,   1,   2,   1,   2,   1,   2,   1,   2,   1,   2,   1,   0,   1],
        [   1,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   1],
        [   1,   2,   1,   2,   1,   2,   1,   2,   1,   2,   1,   2,   1,   2,   1],
        [   1,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   1],
        [   1,   2,   1,   2,   1,   2,   1,   2,   1,   2,   1,   2,   1,   2,   1],
        [   1,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   1],
        [   1,   2,   1,   2,   1,   2,   1,   2,   1,   2,   1,   2,   1,   2,   1],
        [   1,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   1],
        [   1,   0,   1,   2,   1,   2,   1,   2,   1,   2,   1,   2,   1,   0,   1],
        [   1,   0,   0,   2,   2,   2,   2,   2,   2,   2,   2,   2,   0,   0,   1],
        [   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1]
    ];
    let mur = new Array(13);
    for (let i = 0; i < mur.length; i++)
    {
        mur[i] = new Array(15);
    }
    const scale = 1;
    const mvnt_liberty = 6;
    const speed = 7;
    const start_x = 1;
    const start_y = 1;
    const tile_size = 64;
    const width = 960;
    const height = 832;
       let config = {
    type: Phaser.AUTO,
    width: width,
    height: height,
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};

function get_coord_x(x)
{
    return ((x + 0.5) * tile_size);
}

function get_coord_y_player(y)
{
    return ((y + 0.5 - 0.5) * tile_size);
}

function get_coord_y(y)
{
    return ((y + 0.5) * tile_size);
}

function get_player_hitbox(x, y)
{
    var hit = tile_size - scale * mvnt_liberty;
    y += 0.5 * tile_size;
    return [[x + hit / 2, y + hit / 2], [x - hit / 2, y + hit / 2], [x + hit / 2, y - hit / 2], [x - hit / 2, y - hit / 2]]; // 0 bottom right; 1 bottom left; 2 top right; 3 top left
}

function get_case(x_y)
{
    return level[Math.floor(x_y[1] / tile_size)][Math.floor(x_y[0] / tile_size)];
}

var game = new Phaser.Game(config);

function preload ()
{
	load_images(this);
}

function create ()
{
     key_up = this.input.keyboard.addKey('W');
     key_right = this.input.keyboard.addKey('D');
     key_bottom = this.input.keyboard.addKey('S');
     key_left = this.input.keyboard.addKey('A');
	 key_space = this.input.keyboard.addKey('SPACE');

    const map = this.add.image(width / 2, height / 2, 'map');
	Players = {
         W_player : this.add.sprite(get_coord_x(start_x), get_coord_y_player(start_y), 'w_down_0'),
		 face : "down",
	};
	Players.W_player.setDepth(1);
    create_anim();
    for (var i = 0; i < level.length; i++) {
        for (var j = 0; j < level[i].length; j++) {
             if (level[i][j] == 2)
             {
                mur[i][j] = this.add.sprite(get_coord_x(j), get_coord_y(i), 'bomb-0');
             }
         } 
    }
	key = "";
        create_anim();
        // this.add.sprite(200, 200, 'explo-0-mid').play('explo_mid');
        // this.add.sprite(184, 200, 'explo-0-midleft').play('explo_midleft');
        // this.add.sprite(168, 200, 'explo-0-maxleft').play('explo_maxleft');
        // this.add.sprite(200,184, 'explo-0-midtop').play('explo_midtop');
        // this.add.sprite(200,168, 'explo-0-midtop').play('explo_midtop');
        // this.add.sprite(200,150, 'explo-0-midtop').play('explo_midtop');
        // this.add.sprite(200,136, 'explo-0-maxtop').play('explo_maxtop');
        // this.add.sprite(216,200, 'explo-0-midright').play('explo_midright');
        // this.add.sprite(230,200, 'explo-0-maxright').play('explo_maxright');
        // this.add.sprite(200, 216, 'explo-0-middown').play('explo_middown');
        // this.add.sprite(200, 230, 'explo-0-maxdown').play('explo_maxdown');
}

let global = {bombs:[], explo:[]};

function update ()
{
	if (key_up.isDown &&
		 (key_bottom.isUp || key_up.repeats < key_bottom.repeats) &&
		 (key_left.isUp || key_up.repeats < key_left.repeats) && 
		 (key_right.isUp || key_up.repeats < key_right.repeats))
		key = "up";
	else if (key_right.isDown &&
		 (key_up.isUp || key_right.repeats < key_up.repeats) && 
		 (key_left.isUp || key_right.repeats < key_left.repeats) && 
		 (key_bottom.isUp || key_right.repeats < key_bottom.repeats))
		key = "right";
	else if (key_bottom.isDown &&
			(key_right.isUp || key_bottom.repeats < key_right.repeats) && 
			(key_left.isUp || key_bottom.repeats < key_left.repeats) && 
			(key_up.isUp || key_bottom.repeats < key_up.repeats))
		key = "bottom";
	else if (key_left.isDown &&
			(key_bottom.isUp || key_left.repeats < key_bottom.repeats) && 
			(key_up.isUp || key_left.repeats < key_up.repeats) && 
			(key_right.isUp || key_left.repeats < key_right.repeats))
		key = "left";
	else
		key = key;
	if (key == "up" && key_up.isUp)
		key = "";
	if (key == "right" && key_right.isUp)
		key = "";
	if (key == "bottom" && key_bottom.isUp)
		key = "";
	if (key == "left" && key_left.isUp)
		key = "";
	movement();
	if (key_space.isDown)
	{
		//let pos = {x:pixel2map(Players.W_player.x) , y:pixel2map(Players.W_player.y)};
		let pos = player_pixel_2_map(Players.W_player);
		global.bombs.push(bomb_anim(this, pos, 3));
	}
}
	</script>

	<script src="create_anim.js"></script>
	<script src="manage_mvt.js"></script>
	<script src="create_bomb_anim.js"></script>
	<script src="load_images.js"></script>
	<script src="utils.js"></script>
</body>
</html>
